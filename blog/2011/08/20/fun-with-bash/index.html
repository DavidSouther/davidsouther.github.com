
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fun With Bash - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="I freakin love bash. The thing&rsquo;s amazing, with some ridiculous language constructs that even perl can&rsquo;t dream of. If the unix philosophy &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://DavidSouther.github.io/blog/2011/08/20/fun-with-bash">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:DavidSouther.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Fun With Bash</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-20T17:31:56-04:00" pubdate data-updated="true">Aug 20<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I freakin love bash. The thing&rsquo;s amazing, with some ridiculous language constructs that even perl can&rsquo;t dream of. If the unix philosophy is &ldquo;one task, one tool,&rdquo; Bash&rsquo;s task is glue.</p>

<p>I&rsquo;ve been using it over the past week on a digital forensics case. This is a project that involves examining a dozen production hard disks for any artifacts of inappropriate or malicious use (hacking, malware, unauthorized websites, breach of data policy, etc etc). The disks I&rsquo;m analyzing are about 120GB a piece, dual-boot between Windows XP and various linux distros. After some initial analysis, we have 3 data partitions per disk, and somewhere between 300 and 400 thousand artifacts per partition. That&rsquo;s over 10 million artifacts to collect and analyse, from 12 different physical devices. This is for a court case, so rules of evidence and expert witness rules apply- notes. Lots and lots of meticulous notes. Guess what? Bash makes it easy.</p>

<!-- more -->


<p>Â To start off, I only actually had two physical devices to work from. Following consequences of <a href="http://en.wikipedia.org/wiki/Locard's_exchange_principle">Locard&rsquo;s principle</a>, the original devices were raw copied (<code>dd</code>ed) to a pair of aggregate drives. These aggregates then had a single file system with a handful of .raw files each. That&rsquo;s where we start from. Here are the tools I&rsquo;ve added to my belt (and <code>.bashrc</code>).</p>

<h3>bkvs</h3>

<p><a href="http://davidsouther.com/2011/08/bkvs-bash-keyvalue-store/">bkvs</a> is a little script I wrote that abstracts the file system into a key/value pair. It handles directory creation, file management, and generally keeps things from breaking. You&rsquo;ll see me using it several times, so it might help to read the man page, but generally, it supports <code>get(key</code>), <code>set(key, value)</code>, <code>add(key, value)</code> and <code>delete(key)</code>.</p>

<h3>history -a</h3>

<p><a href="http://ss64.com/bash/history.html">history</a> can append the current session to a file. Better yet, it only prints the history that&rsquo;s happened since the last time it was written. This makes it really easy to play around with a few commands, get the syntax right, save the history to your notes, clean it up, and then move on with the next step.</p>

<h3>Intermediate Scripts</h3>

<p>Because of the similarity in naming conventions and the tasks I&rsquo;m doing on each individual drive, I&rsquo;ll need to run the same command on several different partitions. xargs is built exactly for this. Or so it thinks. Actually, xargs is for running a single command inside a pipeline. I need to run several different pipelines, and building those pipes in xargs would be tricky, I think. Further, xargs could have a subtly different invocation each time it gets put in a pipe, and I don&rsquo;t know exactly what the command line expanded to. xargs also can&rsquo;t easily build a pipeline of Instead, I&rsquo;ve started using intermediate shell scripts. In general, I&rsquo;ll have a loop or pipeline that has variables bound and delimited fields in the pipe, and use awk to construct the command line I&rsquo;d want to run. Then, instead of executing it immediately, I wrap the entire looped pip in braces, and redirect that output to an intermediate script.</p>

<p>[bash]
{
for drive in $(bkvs get drives)
do
bkvs get $drive/offsets | fgrep NTFS | awk &ldquo;{print &#34;log2timeline -p -r -f winxp bkvs/$drive/\&rdquo; \$1 \&ldquo; | bkvs add $drive/\&rdquo; \$1 \&ldquo;.timeline\&rdquo;}&ldquo;
done
} >| mount_timelines.sh
[/bash]</p>

<p>This builds a nice script that looks very regular:</p>

<p>[bash]
log2timeline -p -r -f winxp bkvs/6HD1/6HD1.raw2 | bkvs add 6HD1/6HD1.raw2.timeline
log2timeline -p -r -f winxp bkvs/6HD2/6HD2.raw2 | bkvs add 6HD2/6HD2.raw2.timeline
log2timeline -p -r -f winxp bkvs/6HD2/6HD2.raw5 | bkvs add 6HD2/6HD2.raw5.timeline
log2timeline -p -r -f winxp bkvs/6HD3/6HD3.raw2 | bkvs add 6HD3/6HD3.raw2.timeline
log2timeline -p -r -f winxp bkvs/6HD4/6HD4.raw1 | bkvs add 6HD4/6HD4.raw1.timeline
log2timeline -p -r -f winxp bkvs/6HD5/6HD5.raw1 | bkvs add 6HD5/6HD5.raw1.timeline
log2timeline -p -r -f winxp bkvs/6HD5/6HD5.raw2 | bkvs add 6HD5/6HD5.raw2.timeline
log2timeline -p -r -f winxp bkvs/6HD6/6HD6.raw2 | bkvs add 6HD6/6HD6.raw2.timeline
log2timeline -p -r -f winxp bkvs/6HD7/6HD7.raw2 | bkvs add 6HD7/6HD7.raw2.timeline
log2timeline -p -r -f winxp bkvs/6HD8/6HD8.raw2 | bkvs add 6HD8/6HD8.raw2.timeline
[/bash]</p>

<h3>Paralyze</h3>

<p>What I actually mean is parallelize, but I always miss a syllable. I want to run this script now, but log2timeline takes a significant chunk of time. I&rsquo;m a guy who&rsquo;s proud of his quad-core processor, and who&rsquo;s done his share of OpenMP and parallelization, so it&rsquo;d be nice to have a way to get my load up around 3.5, instead of the measly 0.1 it usually sits at. I&rsquo;ve added this handy little function to my bashrc.</p>

<p>[bash]
alias ding=&lsquo;echo &ldquo;Done&rdquo; | mail <a href="&#x6d;&#97;&#x69;&#108;&#x74;&#x6f;&#58;&#x64;&#x61;&#118;&#105;&#x64;&#115;&#111;&#117;&#x74;&#104;&#101;&#x72;&#x40;&#x67;&#x6d;&#x61;&#x69;&#108;&#46;&#99;&#111;&#x6d;">&#x64;&#97;&#118;&#x69;&#x64;&#x73;&#111;&#117;&#x74;&#x68;&#x65;&#x72;&#64;&#x67;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#x63;&#111;&#109;</a>&rsquo;
function paralyze() {</p>

<pre><code>file=$1
tmp="$file._tmp"
cat "$file" | awk '{print "{ " $0 "} &amp;"}' | sed 'n;n;s/&amp;$//' | sed '$s/&amp;$//' &gt;| $tmp
nice -n 10 sh $tmp &gt;$file.log 2&gt;$file.log.error
rm $tmp
ding
</code></pre>

<p>}
[/bash]</p>

<p>It takes a single parameter, a bash script in a similar format (one command per line). It adds an ampersand (&amp;) to the end of every line (to background it), and then removes the &amp; from every 3rd line. (Experimentation might show a better number, but I chose p-1 as an ideal of every core having 1 perfect, non-blocking process just running on its own, leaving a core for my desktop). Last it removes the last line&rsquo;s &amp;, so the last line will always block until the end. This gets put in a tmp file, since each line is supposed to be completely independent from every other line. Finally, we run the tmp file as a shell script, niced down low so it doesn&rsquo;t start thrashing, and redirect stdout and stderr to some log files. When it&rsquo;s done, it cleans up, and emails me.</p>

<p>There are a couple issues. First, there&rsquo;s no guarantee that every third line will finish after the lines above it, or that the last line will also finish last. But, without writing some accounting mechanism to watch the current process list, it does a pretty damned good job of letting me run a lot of parallel tasks in the background, without having to monitor them by hand.</p>

<h3>That&rsquo;s all for now</h3>

<p>Those are the four little things I&rsquo;ve picked up on using over the past couple days. Again, the requirements are meticulous notetaking, and automation of repetitive tasks. These little helpers have made my life tremendously easier (in fact, possible) compared to sitting around typing each <code>fdisk -l</code> and <code>mount</code> out by hand.</p>

<h3>Bonus</h3>

<p>From Andrew Niemantsverdreit: (as root)</p>

<p>[bash]strings /dev/mem | more[/bash]</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">admin</span></span>

      








  


<time datetime="2011-08-20T17:31:56-04:00" pubdate data-updated="true">Aug 20<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/technology/'>Technology</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://DavidSouther.github.io/blog/2011/08/20/fun-with-bash/" data-via="" data-counturl="http://DavidSouther.github.io/blog/2011/08/20/fun-with-bash/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/08/19/bkvs-bash-keyvalue-store/" title="Previous Post: bkvs - Bash Key/Value Store">&laquo; bkvs - Bash Key/Value Store</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/08/22/facepalm/" title="Next Post: Facepalm">Facepalm &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/30/testing-its-hard-just-do-it/">Testing. It's Hard. Just Do It!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/25/sitting-at-home/">Sitting at Home, Listening to Beethoven, Thinking of Maenee</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/18/national-gallery-west-building/">National Gallery, West Building</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/14/7th-ave-between-the-square-and-the-park/">7th Ave Between the Square and the Park</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/25/readable-d3/">Readable D3</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

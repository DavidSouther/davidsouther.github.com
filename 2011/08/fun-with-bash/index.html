
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fun With Bash - David Souther</title>
  <meta name="author" content="David Souther <davidsouther@gmail.com>">

  
  <meta name="description" content="I freakin love bash. The thing&rsquo;s amazing, with some ridiculous language constructs that even perl can&rsquo;t dream of. If the unix philosophy &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://DavidSouther.github.io/2011/08/fun-with-bash">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/feed.xml" rel="alternate" title="David Souther" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-505666-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">David Souther</a></h1>
  
    <h2>Crafstmanship - Software, Hardware, Art, Language</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/feed.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:DavidSouther.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Posts</a></li>
  <li><a href="/about-me/">About</a></li>
  <li><a href="/resume/">Resume</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Fun With Bash</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-20T17:31:56-04:00" pubdate data-updated="true">Aug 20<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I freakin love bash. The thing&rsquo;s amazing, with some ridiculous language constructs that even perl can&rsquo;t dream of. If the unix philosophy is &ldquo;one task, one tool,&rdquo; Bash&rsquo;s task is glue.</p>

<p>I&rsquo;ve been using it over the past week on a digital forensics case. This is a project that involves examining a dozen production hard disks for any artifacts of inappropriate or malicious use (hacking, malware, unauthorized websites, breach of data policy, etc etc). The disks I&rsquo;m analyzing are about 120GB a piece, dual-boot between Windows XP and various linux distros. After some initial analysis, we have 3 data partitions per disk, and somewhere between 300 and 400 thousand artifacts per partition. That&rsquo;s over 10 million artifacts to collect and analyse, from 12 different physical devices. This is for a court case, so rules of evidence and expert witness rules apply- notes. Lots and lots of meticulous notes. Guess what? Bash makes it easy.</p>

<!-- more -->


<p>To start off, I only actually had two physical devices to work from. Following consequences of <a href="http://en.wikipedia.org/wiki/Locard's_exchange_principle">Locard&rsquo;s principle</a>, the original devices were raw copied (<code>dd</code>ed) to a pair of aggregate drives. These aggregates then had a single file system with a handful of .raw files each. That&rsquo;s where we start from. Here are the tools I&rsquo;ve added to my belt (and <code>.bashrc</code>).</p>

<h3>bkvs</h3>

<p><a href="http://davidsouther.com/2011/08/bkvs-bash-keyvalue-store/">bkvs</a> is a little script I wrote that abstracts the file system into a key/value pair. It handles directory creation, file management, and generally keeps things from breaking. You&rsquo;ll see me using it several times, so it might help to read the man page, but generally, it supports <code>get(key</code>), <code>set(key, value)</code>, <code>add(key, value)</code> and <code>delete(key)</code>.</p>

<h3>history -a</h3>

<p><a href="http://ss64.com/bash/history.html">history</a> can append the current session to a file. Better yet, it only prints the history that&rsquo;s happened since the last time it was written. This makes it really easy to play around with a few commands, get the syntax right, save the history to your notes, clean it up, and then move on with the next step.</p>

<h3>Intermediate Scripts</h3>

<p>Because of the similarity in naming conventions and the tasks I&rsquo;m doing on each individual drive, I&rsquo;ll need to run the same command on several different partitions. xargs is built exactly for this. Or so it thinks. Actually, xargs is for running a single command inside a pipeline. I need to run several different pipelines, and building those pipes in xargs would be tricky, I think. Further, xargs could have a subtly different invocation each time it gets put in a pipe, and I don&rsquo;t know exactly what the command line expanded to. xargs also can&rsquo;t easily build a pipeline of Instead, I&rsquo;ve started using intermediate shell scripts. In general, I&rsquo;ll have a loop or pipeline that has variables bound and delimited fields in the pipe, and use awk to construct the command line I&rsquo;d want to run. Then, instead of executing it immediately, I wrap the entire looped pip in braces, and redirect that output to an intermediate script.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">{</span>
</span><span class='line'><span class="k">for </span>drive in <span class="k">$(</span>bkvs get drives<span class="k">)</span>
</span><span class='line'><span class="k">do</span>
</span><span class='line'>bkvs get <span class="nv">$drive</span>/offsets | fgrep NTFS | awk <span class="s2">&quot;{print \&quot;log2timeline -p -r -f winxp bkvs/$drive/\&quot; \$1 \&quot; | bkvs add $drive/\&quot; \$1 \&quot;.timeline\&quot;}&quot;</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'><span class="o">}</span> &gt;| mount_timelines.sh
</span></code></pre></td></tr></table></div></figure>


<p>This builds a nice script that looks very regular:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>log2timeline -p -r -f winxp bkvs/6HD1/6HD1.raw2 | bkvs add 6HD1/6HD1.raw2.timeline
</span><span class='line'>log2timeline -p -r -f winxp bkvs/6HD2/6HD2.raw2 | bkvs add 6HD2/6HD2.raw2.timeline
</span><span class='line'>log2timeline -p -r -f winxp bkvs/6HD2/6HD2.raw5 | bkvs add 6HD2/6HD2.raw5.timeline
</span><span class='line'>log2timeline -p -r -f winxp bkvs/6HD3/6HD3.raw2 | bkvs add 6HD3/6HD3.raw2.timeline
</span><span class='line'>log2timeline -p -r -f winxp bkvs/6HD4/6HD4.raw1 | bkvs add 6HD4/6HD4.raw1.timeline
</span><span class='line'>log2timeline -p -r -f winxp bkvs/6HD5/6HD5.raw1 | bkvs add 6HD5/6HD5.raw1.timeline
</span><span class='line'>log2timeline -p -r -f winxp bkvs/6HD5/6HD5.raw2 | bkvs add 6HD5/6HD5.raw2.timeline
</span><span class='line'>log2timeline -p -r -f winxp bkvs/6HD6/6HD6.raw2 | bkvs add 6HD6/6HD6.raw2.timeline
</span><span class='line'>log2timeline -p -r -f winxp bkvs/6HD7/6HD7.raw2 | bkvs add 6HD7/6HD7.raw2.timeline
</span><span class='line'>log2timeline -p -r -f winxp bkvs/6HD8/6HD8.raw2 | bkvs add 6HD8/6HD8.raw2.timeline
</span></code></pre></td></tr></table></div></figure>


<h3>Paralyze</h3>

<p>What I actually mean is parallelize, but I always miss a syllable. I want to run this script now, but log2timeline takes a significant chunk of time. I&rsquo;m a guy who&rsquo;s proud of his quad-core processor, and who&rsquo;s done his share of OpenMP and parallelization, so it&rsquo;d be nice to have a way to get my load up around 3.5, instead of the measly 0.1 it usually sits at. I&rsquo;ve added this handy little function to my bashrc.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">alias </span><span class="nv">ding</span><span class="o">=</span><span class="s1">&#39;echo &quot;Done&quot; | mail davidsouther@gmail.com&#39;</span>
</span><span class='line'><span class="k">function </span>paralyze<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'>  <span class="nv">tmp</span><span class="o">=</span><span class="s2">&quot;$file._tmp&quot;</span>
</span><span class='line'>  cat <span class="s2">&quot;$file&quot;</span> | awk <span class="s1">&#39;{print &quot;{ &quot; $0 &quot;} &amp;&quot;}&#39;</span> | sed <span class="s1">&#39;n;n;s/&amp;$//&#39;</span> | sed <span class="s1">&#39;$s/&amp;$//&#39;</span> &gt;| <span class="nv">$tmp</span>
</span><span class='line'>  nice -n 10 sh <span class="nv">$tmp</span> &gt;<span class="nv">$file</span>.log 2&gt;<span class="nv">$file</span>.log.error
</span><span class='line'>  rm <span class="nv">$tmp</span>
</span><span class='line'>  ding
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It takes a single parameter, a bash script in a similar format (one command per line). It adds an ampersand (&amp;) to the end of every line (to background it), and then removes the &amp; from every 3rd line. (Experimentation might show a better number, but I chose p-1 as an ideal of every core having 1 perfect, non-blocking process just running on its own, leaving a core for my desktop). Last it removes the last line&rsquo;s &amp;, so the last line will always block until the end. This gets put in a tmp file, since each line is supposed to be completely independent from every other line. Finally, we run the tmp file as a shell script, niced down low so it doesn&rsquo;t start thrashing, and redirect stdout and stderr to some log files. When it&rsquo;s done, it cleans up, and emails me.</p>

<p>There are a couple issues. First, there&rsquo;s no guarantee that every third line will finish after the lines above it, or that the last line will also finish last. But, without writing some accounting mechanism to watch the current process list, it does a pretty damned good job of letting me run a lot of parallel tasks in the background, without having to monitor them by hand.</p>

<h3>That&rsquo;s all for now</h3>

<p>Those are the four little things I&rsquo;ve picked up on using over the past couple days. Again, the requirements are meticulous notetaking, and automation of repetitive tasks. These little helpers have made my life tremendously easier (in fact, possible) compared to sitting around typing each <code>fdisk -l</code> and <code>mount</code> out by hand.</p>

<h3>Bonus</h3>

<p>From Andrew Niemantsverdreit: (as root)</p>

<p><code>strings /dev/mem | more</code></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">admin</span></span>

      








  


<time datetime="2011-08-20T17:31:56-04:00" pubdate data-updated="true">Aug 20<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/categories/technology/'>Technology</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://DavidSouther.github.io/2011/08/fun-with-bash/" data-via="david_souther" data-counturl="http://DavidSouther.github.io/2011/08/fun-with-bash/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2011/08/bkvs-bash-keyvalue-store/" title="Previous Post: bkvs - Bash Key/Value Store">&laquo; bkvs - Bash Key/Value Store</a>
      
      
        <a class="basic-alignment right" href="/2011/08/goal-oriented-behavior-2009-0/" title="Next Post: Goal Oriented Behavior - July 2009">Goal Oriented Behavior - July 2009 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
<section>
  <h1>Stack Overflow Answers</h1>
  <ul id="stackoverflow">
    <li class="loading">Answers updating...</li>
  </ul>
  <script type="text/javascript">
    $(function(){
      getStackOverflowFeed("240358", 7);
    });
  </script>
  <script src="/javascripts/stackoverflow.js" type="text/javascript"> </script>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/01/angularjs-mock-render/">AngularJS Mock Render</a>
      </li>
    
      <li class="post">
        <a href="/2013/10/testing-its-hard-just-do-it/">Testing. It's Hard. Just Do It!</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/sitting-at-home/">Sitting at Home, Listening to Beethoven, Thinking of Maenee</a>
      </li>
    
      <li class="post">
        <a href="/2013/03/national-gallery-west-building/">National Gallery, West Building</a>
      </li>
    
      <li class="post">
        <a href="/2013/03/7th-ave-between-the-square-and-the-park/">7th Ave Between the Square and the Park</a>
      </li>
    
      <li class="post">
        <a href="/2013/02/readable-d3/">Readable D3</a>
      </li>
    
      <li class="post">
        <a href="/2013/01/this-rationalists-world-view/">This Rationalist's World-View</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/DavidSouther">@DavidSouther</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'DavidSouther',
            count: 7,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/davidsouther?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - David Souther <davidsouther@gmail.com> -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

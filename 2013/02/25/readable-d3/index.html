
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Readable D3 - David Souther</title>
  <meta name="author" content="David Souther <davidsouther@gmail.com>">

  
  <meta name="description" content="d3 example code is horribly convoluted, depending on dozens of unstructured variables (and often some global magic) to achieve even the simplest &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://DavidSouther.github.io/2013/02/25/readable-d3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/feed.xml" rel="alternate" title="David Souther" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-505666-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">David Souther</a></h1>
  
    <h2>Crafstmanship - Software, Hardware, Art, Language</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/feed.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:DavidSouther.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about-me/">About</a></li>
  <li><a href="/resume/">Resume</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Readable D3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-25T22:26:58-05:00" pubdate data-updated="true">Feb 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="https://github.com/mbostock/d3/wiki/Gallery">d3 example code</a> is horribly convoluted, depending on dozens of unstructured variables (and often some global magic) to achieve even the simplest effects. To improve the readability of my d3 projects, I&rsquo;ve introduced a Canvas container, with the most commonly used properties conveniently encapsulated in a single object. Combined with mbostocks discussion in <a href="http://bost.ocks.org/mike/chart/">Towards Reusable Charts</a>, the canvas container can be used in nearly any project to greatly improve the structure and quality of d3 code.</p>

<!-- more -->




<figure class='code'><figcaption><span>&#8220;Readable Canvas (canvas.js)&#8221;</span><a href='https://gist.github.com/DavidSouther/5035560#file-canvas-js'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">    Get a new SVG canvas, with margins and scales. Pass an object as `options` to</span>
</span><span class='line'><span class="cm">    set values. Defaults:</span>
</span><span class='line'><span class="cm">  </span>
</span><span class='line'><span class="cm">    {</span>
</span><span class='line'><span class="cm">      size: # Size of SVG. Returned size will be smaller by the size of the margins.</span>
</span><span class='line'><span class="cm">        width: 960</span>
</span><span class='line'><span class="cm">        height: 500</span>
</span><span class='line'><span class="cm">      margin: # Margins for the graphic.</span>
</span><span class='line'><span class="cm">        top: 20</span>
</span><span class='line'><span class="cm">        right: 20</span>
</span><span class='line'><span class="cm">        bottom: 30</span>
</span><span class='line'><span class="cm">        left: 40</span>
</span><span class='line'><span class="cm">      scale: # d3.scales to scale against the canvas</span>
</span><span class='line'><span class="cm">        x: linear</span>
</span><span class='line'><span class="cm">        y: linear</span>
</span><span class='line'><span class="cm">      domain: # Domain of scales for the canvas.</span>
</span><span class='line'><span class="cm">        x: [0, 1]</span>
</span><span class='line'><span class="cm">        y: [0, 1]</span>
</span><span class='line'><span class="cm">    }</span>
</span><span class='line'><span class="cm"> </span>
</span><span class='line'><span class="cm">    @param root String selector for finding the SVG element.</span>
</span><span class='line'><span class="cm">    @param options Object matching the defaults to override.</span>
</span><span class='line'><span class="cm">    @return Object with defaults, overriden by the options, and an additional two properties:</span>
</span><span class='line'><span class="cm">      {</span>
</span><span class='line'><span class="cm">        svg: SVG_Element # SVG root</span>
</span><span class='line'><span class="cm">        defs: SVG_Defs_Element # &lt;defs&gt; to attach gradient and filter definitions to.</span>
</span><span class='line'><span class="cm">      }</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">Canvas</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">options</span><span class="p">){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">margin</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span> <span class="nx">svg</span><span class="p">,</span> <span class="nx">scales</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">root</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">root</span> <span class="o">=</span> <span class="s1">&#39;body&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">options</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
</span><span class='line'>    <span class="nx">options</span><span class="p">.</span><span class="nx">size</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="p">{});</span>
</span><span class='line'>    <span class="nx">options</span><span class="p">.</span><span class="nx">margin</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">margin</span> <span class="o">=</span> <span class="p">{});</span>
</span><span class='line'>    <span class="nx">options</span><span class="p">.</span><span class="nx">scale</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="p">{});</span>
</span><span class='line'>    <span class="nx">margin</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">top</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">||</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">right</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">||</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">bottom</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">||</span> <span class="mi">30</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">left</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">||</span> <span class="mi">40</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">margin</span><span class="p">.</span><span class="nx">leftright</span> <span class="o">=</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">right</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">margin</span><span class="p">.</span><span class="nx">topbottom</span> <span class="o">=</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">bottom</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">width</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">||</span> <span class="mi">960</span><span class="p">)</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">leftright</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">height</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">||</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">topbottom</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">root</span><span class="p">).</span><span class="nx">attr</span><span class="p">({</span>
</span><span class='line'>      <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="nx">width</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">right</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="nx">height</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">bottom</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">scales</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">x</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> <span class="s1">&#39;linear&#39;</span><span class="p">]().</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">]).</span><span class="nx">domain</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]).</span><span class="nx">nice</span><span class="p">(),</span>
</span><span class='line'>      <span class="nx">y</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">y</span> <span class="o">||</span> <span class="s1">&#39;linear&#39;</span><span class="p">]().</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">height</span><span class="p">]).</span><span class="nx">domain</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">y</span> <span class="o">||</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]).</span><span class="nx">nice</span><span class="p">()</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">canvas</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">size</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">width</span><span class="o">:</span> <span class="nx">width</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">height</span><span class="o">:</span> <span class="nx">height</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">margin</span><span class="o">:</span> <span class="nx">margin</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">scale</span><span class="o">:</span> <span class="nx">scales</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">svg</span><span class="o">:</span> <span class="nx">svg</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">defs</span><span class="o">:</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;defs&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">canvas</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This version binds the Canvas closure function to Window. Most of the code is to ensure the appropriate fields are set on the options object. The returned object has the final details of the drawing surface, including its size, the margins, and d3 scales calibrated to the canvas&#8217; coordinates. It also includes a refernce to the root SVG element, as well as the svg:defs element containing any filters or gradients defined for the image.</p>

<p>This object works exceptionally well as the config parameter for reusable charts.</p>

<figure class='code'><figcaption><span>Herzsprung Russel Diagram (starmap.js)</span><a href='https://gist.github.com/DavidSouther/5035560#file-starmap-js'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">spectrate</span><span class="p">,</span> <span class="nx">Starmap</span><span class="p">,</span> <span class="nx">prepare</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Small helper to look up a string</span>
</span><span class='line'>  <span class="nx">spectrate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">star</span><span class="p">){</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;class&quot;</span> <span class="o">+</span> <span class="nx">spectral</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">](</span><span class="o">+</span><span class="nx">star</span><span class="p">.</span><span class="nx">temp</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Given a canvas, add gradient definitions to the svg:defs element.</span>
</span><span class='line'>  <span class="nx">prepare</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvas</span><span class="p">){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">defs</span><span class="p">,</span> <span class="nx">grads</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">defs</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">defs</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">grads</span> <span class="o">=</span> <span class="nx">defs</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;radialGradient&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="c1">// A list of spectral classes</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">spectral</span><span class="p">.</span><span class="nx">spectro</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;svg:radialGradient&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">attr</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">it</span><span class="p">){</span> <span class="k">return</span> <span class="nx">spectrate</span><span class="p">(</span><span class="nx">it</span><span class="p">);</span> <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;cx&#39;</span><span class="o">:</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;cy&#39;</span><span class="o">:</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;r&#39;</span><span class="o">:</span> <span class="o">+</span><span class="mi">1</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="nx">grads</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">attr</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;stop-color&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">it</span><span class="p">){</span> <span class="k">return</span> <span class="nx">it</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">brighter</span><span class="p">();</span> <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;0%&#39;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="nx">grads</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">attr</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;stop-color&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">it</span><span class="p">){</span> <span class="k">return</span> <span class="nx">it</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span> <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;offset&#39;</span><span class="o">:</span> <span class="s1">&#39;100%&#39;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">Starmap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvas</span><span class="p">){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">star</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">prepare</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Callable function to draw circles in a selection</span>
</span><span class='line'>    <span class="c1">// EG a stencil</span>
</span><span class='line'>    <span class="nx">star</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selection</span><span class="p">){</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">circles</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">circles</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;svg:circle&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">attr</span><span class="p">({</span>
</span><span class='line'>          <span class="s2">&quot;r&quot;</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;class&quot;</span><span class="o">:</span> <span class="s2">&quot;star&quot;</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">style</span><span class="p">({</span>
</span><span class='line'>          <span class="s2">&quot;opacity&quot;</span><span class="o">:</span> <span class="mf">0.9</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>      <span class="nx">circles</span><span class="p">.</span><span class="nx">attr</span><span class="p">({</span>
</span><span class='line'>        <span class="s2">&quot;cx&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">it</span><span class="p">){</span> <span class="k">return</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="o">+</span><span class="nx">it</span><span class="p">.</span><span class="nx">temp</span><span class="p">);</span> <span class="p">},</span>
</span><span class='line'>        <span class="s2">&quot;cy&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">it</span><span class="p">){</span> <span class="k">return</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">y</span><span class="p">(</span><span class="o">+</span><span class="nx">it</span><span class="p">.</span><span class="nx">mag</span><span class="p">);</span> <span class="p">},</span>
</span><span class='line'>        <span class="s2">&quot;fill&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">it</span><span class="p">){</span> <span class="k">return</span> <span class="s2">&quot;url(#&quot;</span> <span class="o">+</span> <span class="nx">spectrate</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="nx">selection</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// The main stencil. Takes an svg:g layer from inside canvas.svg</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">layer</span><span class="p">){</span>
</span><span class='line'>      <span class="c1">// Load the spectrum data</span>
</span><span class='line'>      <span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">(</span><span class="s2">&quot;hr.csv&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stars</span><span class="p">){</span>
</span><span class='line'>        <span class="nx">layer</span><span class="p">.</span><span class="nx">attr</span><span class="p">({</span>
</span><span class='line'>            <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s2">&quot;herzrus&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;transform&#39;</span><span class="o">:</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">right</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
</span><span class='line'>          <span class="p">})</span>
</span><span class='line'>          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
</span><span class='line'>          <span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.star&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">stars</span><span class="p">)</span>
</span><span class='line'>          <span class="c1">// Chained call to the reusable star stencil.</span>
</span><span class='line'>          <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">star</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example, StarMap will draw a Herzsprung Russel diagram on the layer. An HR diagram is a log-linear scatterplot of stellar temperature to luminosity. This example takes a canvas to attach Gradient definitions to, and returns a function that will draw the HR diagram on a layer. The stencil function loads data from a CSV file, and uses an inner stencil funtion to draw the individual stars.</p>

<p>Using the two is similarly easy.</p>

<figure class='code'><figcaption><span>Starmap</span><a href='https://gist.github.com/DavidSouther/5035560#file-starmap-html'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>HR in D3<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://d3js.org/d3.v3.min.js&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">link</span> <span class="nx">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;styles/nucleosynth.css&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;canvas.js&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;starmap.js&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/head&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">svg</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;chart&quot;</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">defs</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">filter</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;oil&quot;</span> <span class="nx">filterUnits</span><span class="o">=</span><span class="s2">&quot;objectBoundingBox&quot;</span> <span class="nx">x</span><span class="o">=</span><span class="s2">&quot;0%&quot;</span> <span class="nx">y</span><span class="o">=</span><span class="s2">&quot;0%&quot;</span> <span class="nx">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span> <span class="nx">height</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">femorphology</span> <span class="k">in</span><span class="o">=</span><span class="s2">&quot;SourceGraphic&quot;</span> <span class="nx">radius</span><span class="o">=</span><span class="s2">&quot;2&quot;</span> <span class="nx">result</span><span class="o">=</span><span class="s2">&quot;result_oil_morph&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">feturbulence</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;turbulence&quot;</span> <span class="nx">baseFrequency</span><span class="o">=</span><span class="s2">&quot;0.05&quot;</span> <span class="nx">numOctaves</span><span class="o">=</span><span class="s2">&quot;2&quot;</span> <span class="nx">result</span><span class="o">=</span><span class="s2">&quot;result_oil_turb&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">fedisplacementmap</span> <span class="k">in</span><span class="o">=</span><span class="s2">&quot;result_oil_morph&quot;</span> <span class="nx">in2</span><span class="o">=</span><span class="s2">&quot;result_oil_turb&quot;</span> <span class="nx">scale</span><span class="o">=</span><span class="mi">4</span> <span class="nx">xChannelSelector</span><span class="o">=</span><span class="s2">&quot;R&quot;</span> <span class="nx">yChannelSelector</span><span class="o">=</span><span class="s2">&quot;G&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/filter&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="err">/defs&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/svg&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">background</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">Canvas</span><span class="p">(</span><span class="s1">&#39;#chart&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">scale</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">x</span><span class="o">:</span> <span class="s1">&#39;log&#39;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="nx">domain</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">x</span><span class="o">:</span> <span class="p">[</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
</span><span class='line'>                <span class="nx">y</span><span class="o">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="nx">background</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;svg:g&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;filter:url(#oil);&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">background</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;svg:image&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">attr</span><span class="p">({</span>
</span><span class='line'>                <span class="s1">&#39;xlink:href&#39;</span><span class="o">:</span> <span class="s2">&quot;assets/dfb.png&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">leftright</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">+</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">margin</span><span class="p">.</span><span class="nx">topbottom</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;x&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;y&#39;</span><span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="nx">Starmap</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)(</span><span class="nx">background</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;svg:g&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example, the SVG is preloaded in the HTML with a filter already defined. The script gets a canvas with a few custom properties, attaches a background image, then creates the Starmap and uses it immediately.</p>

<p>This pattern has been very helpful keeping my code clean.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">admin</span></span>

      








  


<time datetime="2013-02-25T22:26:58-05:00" pubdate data-updated="true">Feb 25<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/technology/'>Technology</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://DavidSouther.github.io/2013/02/25/readable-d3/" data-via="david_souther" data-counturl="http://DavidSouther.github.io/2013/02/25/readable-d3/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2013/01/11/this-rationalists-world-view/" title="Previous Post: This Rationalist's World-View">&laquo; This Rationalist's World-View</a>
      
      
        <a class="basic-alignment right" href="/2013/03/14/7th-ave-between-the-square-and-the-park/" title="Next Post: 7th ave between the square and the park">7th ave between the square and the park &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
<section>
  <h1>Stack Overflow Answers</h1>
  <ul id="stackoverflow">
    <li class="loading">Answers updating...</li>
  </ul>
  <script type="text/javascript">
    $(function(){
      getStackOverflowFeed("240358", 7);
    });
  </script>
  <script src="/javascripts/stackoverflow.js" type="text/javascript"> </script>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/10/30/testing-its-hard-just-do-it/">Testing. It's Hard. Just Do It!</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/25/sitting-at-home/">Sitting at Home, Listening to Beethoven, Thinking of Maenee</a>
      </li>
    
      <li class="post">
        <a href="/2013/03/18/national-gallery-west-building/">National Gallery, West Building</a>
      </li>
    
      <li class="post">
        <a href="/2013/03/14/7th-ave-between-the-square-and-the-park/">7th Ave Between the Square and the Park</a>
      </li>
    
      <li class="post">
        <a href="/2013/02/25/readable-d3/">Readable D3</a>
      </li>
    
      <li class="post">
        <a href="/2013/01/11/this-rationalists-world-view/">This Rationalist's World-View</a>
      </li>
    
      <li class="post">
        <a href="/2012/12/07/observers-in-my-syntax/">Observers? In *my* Syntax?</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/DavidSouther">@DavidSouther</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'DavidSouther',
            count: 7,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/davidsouther?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - David Souther <davidsouther@gmail.com> -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
